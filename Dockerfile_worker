FROM debian:sid-slim
MAINTAINER Jelmer Vernooij <jelmer@debian.org>

RUN apt update && apt install --no-install-recommends -y ssh python3 pristine-tar python3-urllib3 python3-aiohttp python3-merge3 python3-configobj python3-jinja2 python3-debian python3-asyncpg python3-protobuf protobuf-compiler python3-yaml python3-apt python3-distro-info devscripts python3-prometheus-client python3-gpg python3-requirement-parser python3-ruamel.yaml quilt python3-psycopg2 sbuild schroot autopkgtest python3-iniparse debootstrap python3-bs4 python3-lxml git-buildpackage pristine-tar lintian perl-doc python3-patiencediff python3-tomlkit python3-setuptools python3-toml python3-pip debcargo cargo dpkg python3-semver cme libconfig-model-dpkg-perl gnome-pkg-tools python3-tr && apt clean && pip3 install google-cloud-logging mypy-protobuf
ENV PYTHONPATH=/code:/code/breezy:/code/dulwich:/code/lintian-brush:/code/ognibuild:/code/silver-platter:/code/buildlog-consultant:/code/upstream-ontologist:/code/debmutate
ENV PATH="/code/breezy-debian/scripts:/code/lintian-brush/scripts:/code/debmutate/scripts:/code/breezy:${PATH}"
ENV BRZ_PLUGINS_AT=debian@/code/breezy-debian
ENV AUTOPKGTEST=/code/autopkgtest-wrapper
ADD . /code
RUN make -C /code
COPY sbuildrc /root/.sbuildrc
RUN mkdir /chroots && /code/create-sbuild-chroot.py --config=/code/janitor.conf /chroots/unstable-amd64-sbuild --make-sbuild-tarball=/chroots/unstable-amd64-sbuild.tar.gz
# Hack for statoverride issue
EXPOSE 8080
ENTRYPOINT ["python3", "-m", "janitor.worker", "--port=8080", "--listen-address=0.0.0.0"]
