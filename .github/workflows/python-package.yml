---
name: Python package - Check, build and test

env:
  # Enable forward compatibility with newer versions of Python
  PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"

"on":
  push:
  pull_request:
  schedule:
    - cron: '0 6 * * *'    # Daily 6AM UTC build

jobs:
  checks:
    name: Checks
    runs-on: ubuntu-latest

    # Steps to perform in job
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Python style checks (Ruff)
        if: always()
        run: |
          set -x
          make ruff

      - name: HTML style checks (djLint)
        if: always()
        run: |
          set -x
          make djlint

      - name: YAML style checks (yamllint)
        if: always()
        run: |
          set -x
          make yamllint

      - name: Rust style checks (rustfmt)
        if: always()
        run: |
          set -x
          cargo fmt --check --all

      - name: Check common misspellings (codespell)
        if: always()
        run: |
          set -x
          codespell

  build:
    name: Ubuntu-latest (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
      fail-fast: false

    # Steps to perform in job
    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Checkout code
        uses: actions/checkout@v4

      # Due to PyPi's gpg v1.10.0 needing libgpgme-dev < 1.18.0-3
      - name: Install PyPi GPG backward compatibility hacks
        run: |
          set -x
          mkdir -pv "$HOME/.local/bin"
          cp -vr ./scripts/* "$HOME/.local/bin/"
          echo "$HOME/.local/bin" | tee -a $GITHUB_PATH

      - name: Install dependencies (apt)
        run: |
          set -x
          sudo apt-get update --yes
          # Matches default: ./Dockerfile_*
          sudo apt-get satisfy --yes --no-install-recommends \
            ca-certificates
            cargo
            gcc
            git
            libclang-dev
            libgpgme-dev
            libpython3-dev
            libssl-dev
            libtdb-dev
            make
            mypy-protobuf
            pkg-config
            protobuf-compiler
            python3-gpg
            python3-pip
            python3-setuptools
            python3-setuptools-rust
            python3-wheel
            python3-wheel-whl
            rustc
            swig
          # Matches extra packages: ./Dockerfile_*
          sudo apt-get satisfy --yes --no-install-recommends \
            apt-file
            autoconf
            autopkgtest
            debootstrap
            devscripts
            diffoscope
            dpkg
            dpkg-dev
            g++
            git-buildpackage
            gnome-pkg-tools
            gnupg
            libapt-pkg-dev
            libjs-chart.js
            libjs-jquery
            libjs-jquery-datatables
            libjs-jquery-typeahead
            libjs-moment
            libjs-sphinxdoc
            lintian
            mypy-protobuf
            openssh-client
            perl-doc
            pristine-tar
            python3
            python3-breezy
            python3-setuptools-protobuf
            quilt
            sbuild
            ssh
            subversion

      - name: Install dependencies (rust)
        run: |
          set -x
          git clone https://github.com/jelmer/ognibuild.git /tmp/ognibuild/
          pushd /tmp/ognibuild/
          cargo build --verbose

      - name: PIP install & setup
        run: |
          set -x
          pip3 install --break-system-packages --upgrade --editable \
            .[dev,debian]
          python3 setup.py develop
          python3 setup.py build_ext -i

      - name: Make
        run: |
          set -x
          make

      - name: Make all
        run: |
          set -x
          make all

      - name: Python static typing checks (mypy)
        if: always()
        run: |
          set -x
          make typing

      - name: Test config (janitor.debian.net)
        if: always()
        run: |
          set -x
          git clone https://salsa.debian.org/janitor-team/janitor.debian.net \
            janitor.debian.net
          PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python PYTHONPATH=py \
            python3 -m janitor.config janitor.debian.net/k8s/janitor.conf

      - name: Test using ./tests/test_*.py (unittest)
        if: always()
        run: |
          set -x
          sudo apt-get satisfy --yes --no-install-recommends \
            postgresql
          pip3 install --break-system-packages --upgrade \
            .[test]
          if test "$(id -u)" = "0"; then
            echo "-- Switching to postgres user"
            chown -R postgres: .
            su postgres -c 'make test'
          else
            echo "-- Running as: $(whoami)"
            make test
          fi
        env:
          PYTHONHASHSEED: random
