{% extends "layout.html" %}
{% block sidebar %}
    {% if not campaign %}
        {% include "cupboard/sidebar.html" %}
    {% else %}
        {% include [campaign + "/sidebar.html", "generic/sidebar.html"] %}
    {% endif %}
{% endblock sidebar %}
{% block page_title %}
    Changes that have been merged or pushed
    {% if campaign %}- {{ campaign }}{% endif %}
{% endblock page_title %}
{% block body %}
    <div class="section" id="history">
        <h1>Changes to have been merged or pushed</h1>

        <form method="get" action="/{{ campaign }}/done">
        <label for="start">Start date:</label>

        <input type="date" id="since" name="since"
               {% if since %}
               value="{{ since.date().isoformat() }}"
               {% elif oldest %}
               value="{{ oldest.date().isoformat() }}"
               {% endif %}
               {% if oldest %}
               min="{{ oldest.date().isoformat() }}"
               {% endif %}
               max="{{ utcnow().date().isoformat() }}"/>
        <input type="submit" value="Refresh"/>
        </form>

        {% set last_date = None %}
        <ul>
        {% for run in runs %}
            {% if run.absorbed_at %}{% set run_date = run.absorbed_at.date().isoformat() %}{% else %}{% set run_date = 'unknown' %}{% endif %}
            {% if run_date != last_date %}
                {% if last_date %}</ul>{% endif %}
                {% set last_date = run_date %}
                <h2>{{ last_date }}</h2>
                <ul>
            {% endif %}
                <li>
                    <a href="pkg/{{ run.package }}/{{ run.id }}">{{ run.package }}</a>
                    {% if run.merged_by %}
                    (merged by {{ run.merged_by }})
                    {% else %}
                    (pushed)
                    {% endif %}
                    </br>
                    {% set command = run.command -%}
                    {% set result = run.result -%}
                    {% include [run.campaign + "/summary.html", "generic/summary.html"] %}
                </li>
            {% endfor %}
        </ul>
    </div>
{% endblock body %}
