{% extends "layout.html" %}
{% from "run_util.html" import local_command, merge_command, reschedule_button, publish_buttons with context %}
{% from "lintian-fixes-util.html" import lintian_tag_link, lintian_brush_summary %}
{% block page_title %}Lintian Fixes - {{ package }}{% endblock %}
{% block body %}
<div class="section" id="{{ package }}">
<h1>{{ package }}</h1>
<ul class="simple">
<li><a class="reference external" href="https://tracker.debian.org/pkg/{{ package }}">QA Page</a></li>
<li>Maintainer email: <a class="reference external" href="mailto:{{ maintainer_email }}">{{ maintainer_email }}</a></li>
<li>Branch URL: <a class="reference external" href="{{ vcs_url }}">{{ vcs_url }}</a></li>
</ul>

{{ reschedule_button(suite, package, "Schedule a new run", "#commandResult") }}

<div id="commandResult"></div>

{% if not result_code %}

{% if previous_runs and previous_runs[0].result_code == 'nothing-to-do' %}
Nothing to do for {{ package }}
{% else %}
No successful runs for {{ package }}
{% endif %}

{% else %}

{% if merge_proposals %}
<div class="section" id="recent-merge-proposals">
<h2>Recent merge proposals</h2>
<ul>
{% for url, status in merge_proposals %}
<li><a href="{{ url }}">{{ url }}</a> ({{ status }})</li>
{% endfor %}
</ul>
</div>
{% endif %}

{% if branch_name %}

<h2>Ready changes</h2>

{{ publish_buttons(suite, package, "#commandResult") }}

{{ merge_command(package, branch_name, vcs) }}

<h3>Summary</h3>

<p>Built on {{ finish_time }} (took {{ format_duration(finish_time - start_time) }})</p>

{{ lintian_brush_summary(result['applied']) }}

<h3>Diff</h3>

{{ highlight_diff(show_diff())|safe }}

{% if result['failed'] %}

<h3>Failed fixers:</h3>
<ul>
{% for tag in result['failed'] %}
   <li>{{ lintian_tag_link(tag) }}</li>
{% endfor %}
</ul>

<p>See the <a href="/cupboard/pkg/{{ package }}/{{ run_id }}/worker.log">worker log</a> for details.</p>

{% endif %}

{% endif %}

<h3>Run locally</h3>

{{ local_command(command, package) }}

<h3>More details</h3>
<p><a href="/cupboard/pkg/{{ package }}/{{ run_id }}">Full run details</a></p>

{% endif %}

{% if previous_runs and previous_runs[0].result_code not in ('nothing-to-do', 'success') %}
<h3>Historical runs</h3>

<ul>
{% for previous_run in previous_runs %}
{% if previous_run != run %}
<li><a href="/cupboard/pkg/{{ package }}/{{ previous_run.id }}">{{ previous_run.result_code }}: {{ previous_run.description }}</a></li>
{% endif %}
{% endfor %}
</ul>

{% endif %}

</div>
{% endblock %}
