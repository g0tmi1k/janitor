{% extends "layout.html" %}
{% block sidebar %}
    {% include "cupboard/sidebar.html" %}
{% endblock sidebar %}
{% block page_title %}
    Review
{% endblock page_title %}
{% block body %}
    <div class="section" id="review">
        <h1>Review</h1>
        <p>
            <a href="/cupboard/pkg/{{ package_name }}/{{ run_id }}/"
               id="full-run-link">Full Run</a>
	    {% if review_instructions_url %}
	    <a href="{{ review_instructions_url }}">Review Instructions</a>
	    {% endif %}
        </p>
	<div id="evaluate">{{ evaluate|safe }}</div>
        <script type="text/javascript">
            function loadRun(package, run_id) {
                $('.review-button').blur();
                $('.review-button').disabled = "disabled";
                $('#evaluate').load("{{ evaluate_url }}".replace('RUN_ID', run_id), function() {
                    $('#full-run-link').attr('href', "/cupboard/pkg/" + package + "/" + run_id);
                    $('#run-id').attr('value', run_id);
                    $('#package-name').attr('value', package);
                    $('.review-button').disabled = "enabled";
                });
            }

            var todo = {{ todo[1: ] | tojson }};
            var queued = new Set();
            todo.forEach(function(entry) {
                queued.add(entry[1]);
            });

            $(function() {
                $('.review-button').attr('type', 'button');
            });

            function loadNewJob() {
                if ((newJob = todo.shift()) !== undefined) {
                    loadRun(newJob.package, newJob.id);
                } else {
                    {% if not publishable_only %}
                        $('.branch').replaceWith('All done!');
                    {% else %}
                        $('.branch').replaceWith('All done! <a href="/cupboard/review?publishable_only=false">Review unpublishable</a>');
                    {% endif %}
                    $('#evaluate').replaceWith('');
                    $('#options').remove();
                    $('#full-run-link').remove();
                }
            }

            function refreshData(cb) {
                console.log("Updating backlog of todo items");
                $.ajax({
                    url: '/cupboard/api/{% if suite %}{{ suite }}/{% endif %}needs-review?required_only=true&{% if user %}&reviewer={{ user['email'] }}{% endif %}&publishable_only={{ 'true ' if publishable_only else 'false ' }}',
                    dataType: 'json',
                    success: function(data) {
                        data.forEach(function(entry) {
                            if (!queued.has(entry[1])) {
                                todo.push(entry);
                                queued.add(entry[1]);
                            }
                        });
                        cb();
                    }
                });
            }

            function submitReview(elem, verdict) {
                var comment = undefined;
                if (verdict == 'rejected') {
                    comment = window.prompt('Please specify a comment for the rejection');
                }
                var run_id = $('#run-id').val();
                var package = $('#package-name').val();
                console.log("Submitting review " + verdict + " for run " + package + "/" + run_id);
                $.ajax('/api/run/' + run_id, {
                    type: "POST",
                    data: {
                        'verdict': verdict,
                        'review-comment': comment
                    },
                    statusCode: {
                       401: function() {
                       {% if user %}
                           alert('failed to submit review: not authorized');
                       {% else %}
                           window.location.replace("/login?url=" + encodeURI(window.location.href));
                       {% endif %}
                       },
                       200: function() {
                           if (todo.length == 0) {
                                refreshData(loadNewJob);
                           } else {
                                loadNewJob();
                           }
                       }
                    }
                });
            }
        </script>
        <form action="/cupboard/review" method="post" id="options">
            <input type="hidden" name="run_id" id="run-id" value="{{ run_id }}"/>
            <input type="hidden"
                   name="package-name"
                   id="package-name"
                   value="{{ package_name }}"/>
            {% if suites %}
                {% for s in suites %}<input type="hidden" name="suites[]" value="{{ s }}"/>{% endfor %}
            {% endif %}
            <input class="review-button"
                   type="submit"
                   name="verdict"
                   value="Approve"
                   accesskey="a"
                   onclick="submitReview(this, 'approved')"/>
            <input class="review-button"
                   type="submit"
                   name="verdict"
                   value="Reject"
                   accesskey="r"
                   onclick="submitReview(this, 'rejected')"/>
            <input class="review-button"
                   type="submit"
                   name="verdict"
                   value="Reschedule"
                   accesskey="s"
                   onclick="submitReview(this, 'reschedule')"/>
            <input class="review-button"
                   type="submit"
                   name="verdict"
                   value="Abstain"
                   accesskey="n"
                   onclick="submitReview(this, 'abstained')"/>
            <input type="checkbox"
                   value="true"
                   name="publishable_only"
                   id="publishable-only"
                   {% if publishable_only %} checked{% endif %}
                   onchange="$('#options').submit()"/>
            <label for="publishable_only">Publishable only</label>
        </form>
    </div>
{% endblock body %}
